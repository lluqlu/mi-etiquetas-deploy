{% extends "base.html" %}
{% block content %}
<div class="contenedor">
    <h2 class="titulo">Consultas de Envíos</h2>

    <form id="formulario-busqueda" method="POST" action="/consultas">
        <label for="codigo">Buscar código de seguimiento:</label>
        <input type="text" id="codigo" name="codigo" placeholder="Ej: AR-1900-01">
        <button type="submit">Buscar</button>
    </form>

    <button onclick="iniciarEscaneo()">
        <i class="fas fa-camera"></i> Escanear con Cámara
    </button>
    <div id="lector-camara" style="width: 300px; margin-top: 10px;"></div>

    <div id="spinner">
        <div class="loader"></div>
    </div>

    {% if mensaje %}
        <p style="color: red;">{{ mensaje }}</p>
    {% endif %}

    {% if resultado %}
    <div class="resultado">
        <h3>Resultado:</h3>
        <p><strong>Código:</strong> {{ resultado['Seguimiento'] }}</p>
        <p><strong>Remitente:</strong> {{ resultado['Remitente'] }}</p>
        <p><strong>DNI Remitente:</strong> {{ resultado['DNI Remitente'] }}</p>
        <p><strong>Celular Remitente:</strong> {{ resultado['Celular Remitente'] }}</p>
        <p><strong>Destinatario:</strong> {{ resultado['Destinatario'] }}</p>
        <p><strong>DNI Destinatario:</strong> {{ resultado['DNI Destinatario'] }}</p>
        <p><strong>CP Destino:</strong> {{ resultado['CP Destino'] }}</p>
        <p><strong>Peso:</strong> {{ resultado['Peso'] }} kg</p>
        <p><strong>Frágil:</strong> {{ 'Sí' if resultado['Fragil'] == '1' else 'No' }}</p>
        <p><strong>Observaciones:</strong> {{ resultado['Observaciones'] }}</p>

        <div class="seguimiento">
            <h4>Seguimiento:</h4>
            <ul>
                {% for evento in eventos %}
                <li>{{ evento['fechahora'] }} - {{ evento['evento'] }}</li>
                {% endfor %}
            </ul>
            <form method="POST" action="/consultas">
                <input type="hidden" name="codigo" value="{{ resultado['Seguimiento'] }}">
                <label for="evento">Nuevo evento:</label>
                <input type="text" name="evento" id="evento" placeholder="Ej: En viaje" required>
                <button type="submit">Agregar evento</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<!-- Estilos para el spinner -->
<style>
  #spinner {
    display: none;
    margin-top: 10px;
  }

  .loader {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 0.8s linear infinite;
    margin: auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Script del escáner + spinner -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  function iniciarEscaneo() {
    const scanner = new Html5Qrcode("lector-camara");
    const config = {
      fps: 10,
      qrbox: 250,
      formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128],
      facingMode: { exact: "environment" }
    };

    scanner.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        document.getElementById("codigo").value = decodedText;
        scanner.stop().then(() => {
          document.getElementById("formulario-busqueda").submit();
        });
      },
      (errorMessage) => {
        // errores ignorados
      }
    ).catch(err => {
      console.error("Error al iniciar escáner:", err);
    });
  }

  document.getElementById("formulario-busqueda").addEventListener("submit", function () {
    document.getElementById("spinner").style.display = "block";
  });
</script>
{% endblock %}



